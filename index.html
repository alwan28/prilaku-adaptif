<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autisme Behavior Assistance</title>
    <!-- Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Konfigurasi font Inter (bersih dan mudah dibaca) -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        inter: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        // Palet warna yang menenangkan
                        'tenang-bg': '#F8FAFC', // Latar belakang (abu-abu sangat muda)
                        'tenang-biru': '#3B82F6', // Biru (untuk interaksi utama)
                        'tenang-hijau': '#10B981', // Hijau (untuk sukses/komunikasi)
                        'tenang-kuning': '#F59E0B', // Kuning (untuk komunikasi)
                        'tenang-ungu': '#8B5CF6', // Ungu (untuk relaksasi)
                        'tenang-oranye': '#F97316', // Oranye (untuk fitur AI)
                        'tenang-teal': '#14B8A6', // Teal (untuk musik) [BARU]
                        'tenang-merah': '#EF4444', // Merah (untuk tombol stop/jeda) [BARU]
                        'tenang-teks': '#1F2937', // Teks (abu-abu gelap, tidak hitam pekat)
                    }
                }
            }
        }
    </script>

    <!-- Memuat Tone.js untuk musik [BARU] -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    
    <!-- Gaya kustom untuk umpan balik dan fokus -->
    <style>
        /* Fokus yang terlihat jelas untuk aksesibilitas */
        :focus-visible {
            outline: 3px solid #3B82F6;
            outline-offset: 2px;
            border-radius: 8px;
        }
        /* Efek mengambang pada tombol menu */
        .menu-button:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* Pesan umpan balik di modul emosi & cerita */
        .feedback-message {
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            margin-top: 1rem;
        }
        .feedback-correct {
            background-color: #D1FAE5; /* green-100 */
            color: #065F46; /* green-800 */
        }
        .feedback-wrong {
            background-color: #FEE2E2; /* red-100 */
            color: #991B1B; /* red-800 */
        }
        
        /* Animasi lingkaran pernapasan */
        @keyframes breathe {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.5);
                opacity: 0.7;
            }
        }
        .animate-breathe {
            animation: breathe 8s ease-in-out infinite;
        }

        /* Animasi untuk tombol musik [BARU] */
        #music-animation.animate-music-pulse {
            animation: music-pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes music-pulse {
            0%, 100% { opacity: 1; transform: scale(1.0); }
            50% { opacity: 0.8; transform: scale(1.1); }
        }

        /* [PERBAIKAN] Animasi fade-in untuk layar modul */
        @keyframes fadeInScreen {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .animate-fadeIn {
            animation: fadeInScreen 0.3s ease-out;
        }

        /* [PERBAIKAN] Menambahkan styling dasar untuk .menu-button */
        .menu-button {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1.5rem; /* p-6 */
            border-radius: 1rem; /* rounded-2xl */
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md */
            transition: all 0.3s;
        }
        /* [PERBAIKAN] Arahkan .menu-button di grid ke kolom */
        .menu-button-grid {
             flex-direction: column;
        }
        /* Efek mengambang pada tombol menu */
        .menu-button:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body class="font-inter bg-tenang-bg text-tenang-teks min-h-screen flex items-center justify-center p-4">

    <!-- Kontainer utama aplikasi -->
    <!-- PERBAIKAN: Menghapus 'min-height: 80vh' dan menambahkan ID 'app-container' -->
    <div id="app-container" class="w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden">
        
        <!-- === [ LAYAR UTAMA (MENU) ] === -->
        <section id="main-menu" class="p-6">

            <!-- [TAMBAHAN BARU] Header Menu Utama (Profil & Notifikasi) -->
            <div class="flex justify-end items-center gap-3 mb-4">
                <!-- [BARU] Menambahkan kelas 'tombol-notifikasi' -->
                <button class="tombol-notifikasi text-gray-400 hover:text-tenang-biru transition-colors" aria-label="Notifikasi">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341A6.002 6.002 0 006 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                    </svg>
                </button>
                <button class="text-gray-400 hover:text-tenang-biru transition-colors" aria-label="Profil Pengguna">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                </button>
            </div>
            <!-- [AKHIR TAMBAHAN] -->

            <h1 class="text-3xl font-bold text-center text-tenang-teks mb-2">Asisten Perilaku</h1>
            <!-- Mengurangi margin bottom sedikit untuk mengimbangi header baru -->
            <p class="text-center text-gray-500 mb-6">Pilih alat bantu yang kamu butuhkan</p>
            
            <!-- [PERUBAHAN LAYOUT] Menggunakan flex-col untuk menata menu -->
            <div class="flex flex-col gap-4">
                
                <!-- Tombol 1: Jadwal Visual (HIGHLIGHT) -->
                <!-- Tombol ini sekarang full-width, di atas, dan lebih deskriptif -->
                <button data-screen="perilaku-module" data-icon="üìÖ" class="menu-button bg-tenang-biru w-full h-32 !justify-start !p-5 !flex-row">
                    <span class="text-5xl mr-4">üìÖ</span>
                    <div>
                        <span class="text-2xl font-bold block">Jadwal Visual</span>
                        <span class="text-sm font-light">Mulai harimu dengan rutinitas</span>
                    </div>
                </button>
                
                <!-- Grid menu utama (2 susun) untuk modul lainnya -->
                <div class="grid grid-cols-2 gap-4">
                    
                    <!-- Tombol 2: Kenali Emosi -->
                    <button data-screen="emosi-module" data-icon="üòä" class="menu-button menu-button-grid bg-tenang-kuning">
                        <span class="text-4xl">üòä</span>
                        <span class="font-semibold">Kenali Emosi</span>
                    </button>
                    
                    <!-- Tombol 3: Aku Mau... -->
                    <button data-screen="komunikasi-module" data-icon="üó£Ô∏è" class="menu-button menu-button-grid bg-tenang-hijau">
                        <span class="text-4xl">üó£Ô∏è</span>
                        <span class="font-semibold">Aku Mau...</span>
                    </button>
                    
                    <!-- Tombol 4: Ayo Tenang -->
                    <button data-screen="relaksasi-module" data-icon="üßò" class="menu-button menu-button-grid bg-tenang-ungu">
                        <span class="text-4xl">üßò</span>
                        <span class="font-semibold">Ayo Tenang</span>
                    </button> <!-- <-- PERBAIKAN: Diubah dari </a-button> menjadi </button> -->

                    <!-- Tombol 5: Pertama... Lalu... -->
                    <button data-screen="first-then-module" data-icon="üëâ" class="menu-button menu-button-grid bg-gray-400">
                        <span class="text-4xl">üëâ</span>
                        <span class="font-semibold">Pertama... Lalu...</span>
                    </button>

                    <!-- Tombol 6: Cerita Sosial -->
                    <button data-screen="cerita-module" data-icon="‚ú®" class="menu-button menu-button-grid bg-tenang-oranye">
                        <span class="text-4xl">‚ú®</span>
                        <span class="font-semibold">Cerita Sosial</span>
                    </button>

                </div> <!-- Akhir dari grid 2 kolom -->

                <!-- Tombol 7: Musik Rileks (TERPISAH) -->
                <!-- Tombol ini sekarang full-width, di bawah, dengan gaya sekunder -->
                <button data-screen="musik-module" data-icon="üéµ" class="menu-button !bg-gray-100 !text-tenang-teks !flex-row !justify-center !p-4 hover:!bg-gray-200">
                    <span class="text-2xl mr-3">üéµ</span>
                    <span class="font-semibold">Musik Rileks</span>
                </button>

            </div>
        </section>
        
        <!-- === [ HEADER MODUL (Dinamis) ] === -->
        <!-- Header ini akan disalin oleh JS ke setiap modul -->
        <!-- PERBAIKAN: Header dibuat 'justify-between' dan ditambahkan 'module-action-slot' -->
        <!-- PERBAIKAN 2: Tambahkan 'hidden' agar tidak tampil di menu utama -->
        <!-- PERBAIKAN 3: Menambahkan ikon Notif & Profil sebagai default -->
        <header id="module-header-template" class="p-4 flex items-center justify-between bg-gray-50 shadow-sm hidden">
            <!-- Grup untuk tombol kembali dan judul -->
            <div class="flex items-center flex-grow">
                <button class="back-to-menu p-2 rounded-full hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-tenang-biru" aria-label="Kembali ke menu">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <!-- Ikon dan Teks Judul Dinamis -->
                <div class="flex items-center ml-2">
                    <span class="module-title-icon text-2xl"></span>
                    <h2 class="module-title-text text-xl font-bold text-tenang-teks ml-2">Judul Modul</h2>
                </div>
            </div>
            <!-- Slot untuk tombol aksi (misal: Pengaturan, Buat Baru) -->
            <!-- [PERBAIKAN] Menambahkan ikon default dan gap -->
            <div class="module-action-slot flex-shrink-0 flex items-center gap-3">
                <!-- Ikon Notifikasi & Profil sekarang default di semua modul -->
                <!-- [BARU] Menambahkan kelas 'tombol-notifikasi' -->
                <button class="tombol-notifikasi text-gray-400 hover:text-tenang-biru transition-colors" aria-label="Notifikasi">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341A6.002 6.002 0 006 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                    </svg>
                </button>
                <button class="text-gray-400 hover:text-tenang-biru transition-colors" aria-label="Profil Pengguna">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                </button>
            </div>
        </header>

        <!-- === [ MODUL 1: JADWAL VISUAL ] === -->
        <section id="perilaku-module" data-title="Jadwal Visual" class="hidden">
            <!-- Konten akan ditambahkan oleh header-template -->
            <div class="p-6 space-y-4">
                <!-- Bilah Progres -->
                <div class="w-full">
                    <p id="progress-text" class="text-sm font-medium text-gray-600 mb-1 text-center">Memuat progres...</p>
                    <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
                        <div id="progress-bar" class="bg-tenang-hijau h-4 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Daftar Tugas Dinamis -->
                <div id="daftar-tugas-container" class="space-y-3">
                    <!-- Tugas akan di-render oleh JS di sini -->
                </div>

                <!-- Tombol Aksi -->
                <div class="flex flex-col space-y-3 pt-4">
                    <button id="tombol-pengaturan" class="w-full px-4 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold flex items-center justify-center space-x-2 hover:bg-gray-300">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.532 1.532 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.532 1.532 0 01-.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106A1.532 1.532 0 0111.49 3.17zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" />
                        </svg>
                        <span>Mode Pengaturan</span>
                    </button>
                    <button id="tombol-hari-baru" class="w-full px-4 py-3 bg-tenang-biru text-white rounded-lg font-semibold hover:bg-blue-700">
                        Mulai Hari Baru
                    </button>
                </div>
                
                <!-- Form Tambah Tugas (Tersembunyi) -->
                <form id="form-tambah-tugas" class="hidden pt-4 space-y-3 border-t">
                    <h3 class="text-lg font-semibold">Tambah Tugas Baru</h3>
                    <div>
                        <label for="input-tugas-teks" class="block text-sm font-medium text-gray-700">Nama Tugas</label>
                        <input type="text" id="input-tugas-teks" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-tenang-biru focus:border-tenang-biru" placeholder="Contoh: Sarapan">
                    </div>
                    <div>
                        <label for="input-tugas-emoji" class="block text-sm font-medium text-gray-700">Emoji (Opsional)</label>
                        <input type="text" id="input-tugas-emoji" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-tenang-biru focus:border-tenang-biru" placeholder="Contoh: ü•û" maxlength="2">
                    </div>
                    <div>
                        <label for="input-tugas-grup" class="block text-sm font-medium text-gray-700">Grup Waktu</label>
                        <select id="input-tugas-grup" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-tenang-biru focus:border-tenang-biru sm:text-sm rounded-md">
                            <option value="pagi">Pagi</option>
                            <option value="siang">Siang</option>
                            <option value="malam">Malam</option>
                        </select>
                    </div>
                    <button type="submit" class="w-full px-4 py-2 bg-tenang-hijau text-white rounded-lg font-semibold hover:bg-green-700">
                        Simpan Tugas
                    </button>
                </form>
            </div>
        </section>

        <!-- === [ MODUL 1b: PERTAMA... LALU... ] === -->
        <section id="first-then-module" data-title="Pertama... Lalu..." class="hidden">
            <!-- Konten akan ditambahkan oleh header-template -->
            <div id="ft-container-setup" class="p-6 space-y-4">
                <!-- Konten akan dirender oleh JS -->
                <h3 class="text-lg font-semibold text-center">Pilih Tugas "Pertama"</h3>
                <div id="ft-pilihan-pertama" class="grid grid-cols-3 gap-2">
                    <!-- Pilihan tugas "Pertama" (dari jadwal) akan di-render JS -->
                </div>
                
                <h3 class="text-lg font-semibold text-center mt-6">Pilih Hadiah "Lalu"</h3>
                <div id="ft-pilihan-lalu" class="grid grid-cols-3 gap-2">
                    <!-- Pilihan "Lalu" (hadiah) akan di-render JS -->
                </div>
                
                <button id="ft-tombol-mulai" class="w-full px-4 py-3 bg-tenang-biru text-white rounded-lg font-semibold hover:bg-blue-700 disabled:bg-gray-400" disabled>
                    Mulai
                </button>
            </div>

            <!-- Tampilan "Aktif" -->
            <div id="ft-container-aktif" class="hidden p-6 space-y-6 flex flex-col items-center justify-center text-center" style="min-height: 70vh;">
                <div class="w-full">
                    <p class="text-2xl font-semibold text-gray-500 mb-2">PERTAMA</p>
                    <div id="ft-card-pertama" class="p-6 bg-gray-100 rounded-xl shadow-md flex flex-col items-center space-y-2">
                        <!-- Konten diisi JS -->
                    </div>
                </div>
                
                <span class="text-6xl font-bold text-tenang-biru">üëá</span>
                
                <div class="w-full">
                    <p class="text-2xl font-semibold text-gray-500 mb-2">LALU</p>
                    <div id="ft-card-lalu" class="p-6 bg-tenang-hijau bg-opacity-20 text-tenang-hijau-darker rounded-xl shadow-md flex flex-col items-center space-y-2">
                        <!-- Konten diisi JS -->
                    </div>
                </div>
                
                <button id="ft-tombol-selesai" class="w-full mt-8 px-4 py-3 bg-tenang-hijau text-white rounded-lg text-lg font-semibold hover:bg-green-700">
                    Aku Sudah Selesai!
                </button>
            </div>
            
            <!-- Tampilan "Selesai/Hore" -->
            <div id="ft-container-selesai" class="hidden p-6 space-y-6 flex flex-col items-center justify-center text-center" style="min-height: 70vh;">
                <span class="text-8xl">üéâ</span>
                <h2 class="text-4xl font-bold text-tenang-hijau">Hore!</h2>
                <p class="text-xl text-gray-600">Sekarang waktunya untuk...</p>
                <div id="ft-card-hadiah-final" class="p-6 bg-tenang-hijau bg-opacity-20 rounded-xl shadow-md flex flex-col items-center space-y-2">
                    <!-- Konten diisi JS -->
                </div>
                <button id="ft-tombol-kembali" class="w-full mt-8 px-4 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300">
                    Selesai
                </button>
            </div>
        </section>

        <!-- === [ MODUL 2: KENALI EMOSI ] === -->
        <section id="emosi-module" data-title="Kenali Emosi" class="hidden p-6 space-y-6">
            <!-- Konten akan ditambahkan oleh header-template -->
            <div class="text-center pt-8">
                <!-- Emoji besar sebagai pertanyaan -->
                <div id="emosi-pertanyaan" class="text-8xl mb-8">
                    <!-- Emoji akan di-load oleh JS -->
                </div>
                
                <!-- Pilihan jawaban -->
                <div id="emosi-pilihan" class="flex flex-col space-y-4">
                    <!-- Tombol pilihan akan di-load oleh JS -->
                </div>
                
                <!-- Umpan Balik -->
                <div id="emosi-umpan-balik" class="feedback-message hidden mt-6">
                    <!-- Umpan balik akan di-load oleh JS -->
                </div>
            </div>
        </section>

        <!-- === [ MODUL 3: AKU MAU... (KOMUNIKASI) ] === -->
        <section id="komunikasi-module" data-title="Aku Mau..." class="hidden p-6 space-y-6">
            <!-- Konten akan ditambahkan oleh header-template -->
            <div id="komunikasi-container" class="grid grid-cols-2 gap-4 pt-4">
                <!-- Kartu komunikasi akan di-load oleh JS -->
            </div>
        </section>

        <!-- === [ MODUL 4: AYO TENANG (RELAKSASI) ] === -->
        <section id="relaksasi-module" data-title="Ayo Tenang" class="hidden p-6">
            <!-- Konten akan ditambahkan oleh header-template -->
            <div class="flex flex-col items-center justify-center space-y-8" style="min-height: 70vh;">
                <!-- Lingkaran animasi pernapasan -->
                <div id="relaksasi-lingkaran" class="w-40 h-40 bg-tenang-ungu rounded-full flex items-center justify-center transition-all duration-[4000ms] ease-in-out">
                    <span id="relaksasi-status-inner" class="text-white text-lg font-semibold transition-opacity duration-1000">Tarik Napas...</span>
                </div>
                <!-- Status teks di luar lingkaran -->
                <span id="relaksasi-status-outer" class="text-2xl font-semibold text-tenang-teks">Tarik Napas...</span>
            </div>
        </section>

        <!-- === [ MODUL 5: CERITA SOSIAL ] === -->
        <section id="cerita-module" data-title="Cerita Sosial ‚ú®" class="hidden p-6 space-y-6">
            <!-- Konten akan ditambahkan oleh header-template -->
            <div id="cerita-container" class="space-y-6 pt-4">
                <!-- Konten Cerita (Skenario) -->
                <div id="cerita-skenario" class="p-4 bg-gray-100 rounded-lg text-lg text-gray-700 leading-relaxed min-h-[100px] flex items-center justify-center text-center">
                    Klik "Buat Cerita Baru" untuk memulai
                </div>
                
                <!-- Pilihan Jawaban -->
                <div id="cerita-pilihan" class="flex flex-col space-y-4">
                    <!-- Pilihan akan di-load oleh JS -->
                </div>
                
                <!-- Umpan Balik -->
                <div id="cerita-umpan-balik" class="feedback-message hidden">
                    <!-- Umpan balik akan di-load oleh JS -->
                </div>
                
                <!-- Tombol Aksi (dipindahkan ke header oleh JS) -->
                <button id="tombol-buat-cerita" class="w-full px-4 py-3 bg-tenang-oranye text-white rounded-lg font-semibold hover:bg-orange-600 flex items-center justify-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z" />
                    </svg>
                    <span>Buat Cerita Baru</span>
                </button>
                <div id="cerita-loading" class="text-center text-gray-500 hidden">
                    <p>Membuat cerita baru...</p>
                </div>
            </div>
        </section>
        
        <!-- === [ MODUL 6: MUSIK RILEKS (BARU) ] === -->
        <section id="musik-module" data-title="Musik Rileks" class="hidden p-6">
            <!-- Konten akan ditambahkan oleh header-template -->
            <div class="flex flex-col items-center justify-center space-y-8 pt-12 pb-4" style="min-height: 70vh;">
                <!-- Animasi Musik -->
                <div class="relative">
                    <div id="music-animation" class="w-48 h-48 bg-tenang-teal rounded-full transition-all duration-1000 ease-in-out"></div>
                    <div class="absolute inset-0 flex items-center justify-center">
                        <span class="text-6xl text-white">üéµ</span>
                    </div>
                </div>
                <!-- Tombol Kontrol -->
                <button id="tombol-play-pause-musik" class="px-8 py-4 bg-tenang-biru text-white rounded-full text-lg font-semibold shadow-lg focus:outline-none focus:ring-2 focus:ring-tenang-biru focus:ring-opacity-50 transition-transform transform hover:scale-105" data-status="stopped">
                    Mulai Musik
                </button>
                <p class="text-sm text-gray-500 text-center px-4">Musik instrumental yang menenangkan akan berulang otomatis.</p>
            
                <!-- [TAMBAHAN BARU] Pemisah dan Fitur Upload MP3 -->
                <div class="w-full pt-6 mt-6 border-t border-gray-200">
                    <p class="text-center text-gray-600 font-semibold mb-4">Atau mainkan file MP3 Anda</p>
                    <label for="input-mp3" class="w-full px-4 py-3 bg-gray-100 text-tenang-teks rounded-lg font-semibold hover:bg-gray-200 flex items-center justify-center space-x-2 cursor-pointer transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                          <path d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" />
                        </svg>
                        <span>Pilih File MP3</span>
                    </label>
                    <input type="file" id="input-mp3" accept=".mp3,audio/mpeg" class="hidden">
                    
                    <audio id="player-mp3" controls class="hidden w-full mt-4"></audio>
                </div>
                <!-- [AKHIR TAMBAHAN] -->
            
            </div>
        </section>


        <!-- === [ DIALOG KONFIRMASI KUSTOM ] === -->
        <div id="dialog-konfirmasi" class="hidden fixed inset-0 bg-gray-900 bg-opacity-60 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm p-6 space-y-4">
                <h3 id="dialog-judul" class="text-xl font-bold text-tenang-teks text-center">Konfirmasi</h3>
                <p id="dialog-pesan" class="text-center text-gray-600">Apakah Anda yakin?</p>
                <div class="flex justify-between space-x-4 pt-2">
                    <button id="dialog-tombol-batal" class="w-full px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300">
                        Batal
                    </button>
                    <button id="dialog-tombol-konfirmasi" class="w-full px-4 py-2 bg-tenang-merah text-white rounded-lg font-semibold hover:bg-red-700">
                        Ya, Lanjutkan
                    </button>
                </div>
            </div>
        </div>

        <!-- === [ DIALOG INFORMASI (ATTENTION) BARU ] === -->
        <div id="dialog-informasi" class="hidden fixed inset-0 bg-gray-900 bg-opacity-60 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm p-6 space-y-4">
                <h3 class="text-xl font-bold text-tenang-teks text-center">Attention</h3>
                <!-- Konten Dialog Diisi Sesuai Permintaan Pengguna -->
                <div class="text-sm text-gray-600 space-y-3 max-h-[60vh] overflow-y-auto" style="text-align: left; line-height: 1.6;">
                    <p><strong>Nama Aplikasi:</strong> Autisme Behavior Assisten</p>
                    <p><strong>Pengembang:</strong>-</p>
                    <p><strong>Tujuan:</strong> Mendukung pembelajaran anak autis dengan pendekatan visual, auditori, dan interaktif.</p>
                    
                    <!-- Daftar Fitur yang DIPERBARUI agar sesuai dengan aplikasi saat ini -->
                    <p><strong>Fitur utama:</strong></p>
                    <ul class="list-disc list-inside ml-4">
                        <li>Jadwal Visual (Dinamis)</li>
                        <li>Kenali Emosi</li>
                        <li>Aku Mau... (Interaksi Suara)</li>
                        <li>Pertama... Lalu...</li>
                        <li>Ayo Tenang (Pernapasan)</li>
                        <li>Cerita Sosial (AI Gemini)</li>
                        <li>Musik Rileks (Tone.js & MP3)</li>
                    </ul>
                    
                    <p class="mt-2"><strong>Petunjuk Penggunaan:</strong></p>
                    <ul class="list-disc list-inside ml-4">
                        <!-- Mengganti "Mulai" dengan "Pilih kategori" -->
                        <li>Pilih kategori pembelajaran di menu utama.</li>
                        <li>Ikuti instruksi yang muncul di layar (tekan tombol, dengarkan suara, atau pilih gambar).</li>
                        <li>Jika muncul ikon üîä, tekan untuk mendengar suara panduan.</li>
                        <li>Setelah selesai, klik "Kembali" (ikon panah) untuk memilih latihan lain.</li>
                    </ul>
                    <p class="font-bold text-center pt-2">üí°Gunakan aplikasi ini bersama guru atau orang tua untuk hasil belajar terbaik.</p>
                </div>
                <div class="pt-2">
                    <button id="dialog-info-tutup" class="w-full px-4 py-2 bg-tenang-biru text-white rounded-lg font-semibold hover:bg-blue-700">
                        Mengerti
                    </button>
                </div>
            </div>
        </div>

    </div> <!-- Akhir dari #app-container -->

    <!-- === [ SCRIPT UTAMA APLIKASI ] === -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- Variabel Global & Inisialisasi ---
            const screens = document.querySelectorAll('section');
            const mainMenu = document.getElementById('main-menu');
            const menuButtons = document.querySelectorAll('.menu-button');
            const headerTemplate = document.getElementById('module-header-template');
            const appContainer = document.getElementById('app-container'); // <-- TAMBAHAN BARU
            
            let activeScreenId = 'main-menu'; // <-- PERBAIKAN: Menambahkan kembali variabel yang hilang
            
            // PERBAIKAN: Membersihkan data audio Base64
            const audioSukses = new Audio('data:audio/mpeg;base64,SUQzBAAAAAAAI1RTSEUAAAABA1RUUkMAAAABAAADR1JEQyAAAAEAAANMYXZmNTguMjkuMTAwAAAAAAAAAAAAAAD/80DEAAAAAABJAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAElVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVD/80DEALQAAAAAAAAAABtAAAAAAAQAAAATEFVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVE0gAAAABvA==');
            // --- PERBAIKAN: Baris di bawah ini dihapus karena menyebabkan SyntaxError ---
            // Si-based64-string-cleaned-up');
            const audioHore = new Audio('data:audio/mpeg;base64,SUQzBAAAAAAAI1RTSEUAAAABA1RUUkMAAAABAAADR1JEQyAAAAEAAANMYXZmNTguMjkuMTAwAAAAAAAAAAAAAAD/80DEAAAAAABIBAVLqAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAElVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVAQAAAAAGgDz9AAAFiFAFAmAiAFIAVgSABUFAAAABgAFNAb/+6AARqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgG+gDz9TAMP/BwAAVgSAAqBAAAGgAFNAb/+6AARqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNDUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgP/80DEAhQAAANIAYFPO6AAAAAAAAAAAAAAA//MYA4AQAABoBAVeqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgNNUqgP/1EAAAAAANIAAAAABVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV');

            // --- Dialog Kustom ---
            const dialog = document.getElementById('dialog-konfirmasi');
            const dialogJudul = document.getElementById('dialog-judul');
            const dialogPesan = document.getElementById('dialog-pesan');
            // const dialogTombolKonfirmasi = document.getElementById('dialog-tombol-konfirmasi'); // <-- Dihapus dari sini
            const dialogTombolBatal = document.getElementById('dialog-tombol-batal');

            // [BARU] Elemen Dialog Informasi
            const dialogInformasi = document.getElementById('dialog-informasi');
            const tombolTutupDialogInfo = document.getElementById('dialog-info-tutup');


            // Fungsi untuk menampilkan dialog konfirmasi
            function tampilkanDialog(judul, pesan, onKonfirmasi) {
                dialogJudul.textContent = judul;
                dialogPesan.textContent = pesan;
                
                // --- PERBAIKAN ---
                // 'getElementById' dipindahkan ke dalam fungsi untuk selalu mengambil tombol
                // yang saat ini ada di DOM, mencegah error 'parentNode is null'.
                let dialogTombolKonfirmasi = document.getElementById('dialog-tombol-konfirmasi');
                // --- AKHIR PERBAIKAN ---

                // Hapus event listener lama agar tidak tumpang tindih
                const tombolKonfirmasiBaru = dialogTombolKonfirmasi.cloneNode(true);
                dialogTombolKonfirmasi.parentNode.replaceChild(tombolKonfirmasiBaru, dialogTombolKonfirmasi);
                
                tombolKonfirmasiBaru.addEventListener('click', () => {
                    onKonfirmasi();
                    dialog.classList.add('hidden');
                }, { once: true }); // Hanya jalankan sekali

                dialogTombolBatal.onclick = () => {
                    dialog.classList.add('hidden');
                };
                
                dialog.classList.remove('hidden');
            }

            // [BARU] Logika untuk menampilkan dialog informasi (lonceng)
            const semuaTombolNotifikasi = document.querySelectorAll('.tombol-notifikasi');
            semuaTombolNotifikasi.forEach(tombol => {
                tombol.addEventListener('click', () => {
                    dialogInformasi.classList.remove('hidden');
                });
            });

            tombolTutupDialogInfo.addEventListener('click', () => {
                dialogInformasi.classList.add('hidden');
            });


            // --- Navigasi Aplikasi ---
            
            // Fungsi untuk menampilkan layar/modul
            function showScreen(screenId, icon = null) { // Tambahkan parameter icon
                
                // --- PERBAIKAN: Atur tinggi kontainer secara dinamis ---
                if (screenId === 'main-menu') {
                    appContainer.style.minHeight = 'auto'; // Hapus min-height di menu
                } else {
                    appContainer.style.minHeight = '80vh'; // Terapkan min-height untuk modul
                }
                // --- AKHIR PERBAIKAN ---

                // Sembunyikan semua layar
                screens.forEach(screen => screen.classList.add('hidden'));
                
                // Tampilkan layar yang dituju
                const targetScreen = document.getElementById(screenId);
                if (targetScreen) {
                    targetScreen.classList.remove('hidden');
                    
                    /* [PERBAIKAN] Tambahkan animasi fade-in */
                    targetScreen.classList.add('animate-fadeIn');
                    // Hapus kelas animasi setelah selesai
                    setTimeout(() => {
                        targetScreen.classList.remove('animate-fadeIn');
                    }, 300);
                    /* [AKHIR PERBAIKAN] */
                    
                    // Hentikan proses yang sedang berjalan di modul lain
                    switch (activeScreenId) {
                        case 'relaksasi-module':
                            // Hentikan animasi pernapasan
                            document.getElementById('relaksasi-lingkaran').classList.remove('animate-breathe');
                            document.getElementById('relaksasi-lingkaran').style.animation = 'none';
                            break;
                        case 'musik-module': // [BARU]
                            if (musicPlaying) {
                                // Jeda musik jika meninggalkan layar
                                tombolPlayPauseMusik.click();
                            }
                            break;
                    }

                    // Inisialisasi header modul jika belum ada
                    if (screenId !== 'main-menu' && !targetScreen.querySelector('header')) {
                        const headerClone = headerTemplate.cloneNode(true);
                        headerClone.removeAttribute('id'); // Pastikan ID unik
                        headerClone.classList.remove('hidden'); // <-- PERBAIKAN: Tampilkan header yang di-clone
                        const title = targetScreen.dataset.title || 'Modul';
                        
                        // Modifikasi: Set teks dan ikon
                        headerClone.querySelector('.module-title-text').textContent = title;
                        if (icon) {
                            headerClone.querySelector('.module-title-icon').textContent = icon;
                        }

                        headerClone.querySelector('.back-to-menu').addEventListener('click', () => showScreen('main-menu'));
                        targetScreen.prepend(headerClone);
                        
                        // Fokuskan header untuk aksesibilitas
                        headerClone.setAttribute('tabindex', '-1');
                        headerClone.focus();

                        // --- [ Logika Pemindahan Tombol Aksi ] ---
                        const actionSlot = headerClone.querySelector('.module-action-slot');
                        
                        // 1. Pindahkan tombol Pengaturan (Jadwal Visual)
                        if (screenId === 'perilaku-module') {
                            actionSlot.innerHTML = ''; // [PERBAIKAN] Kosongkan slot (hapus ikon default)
                            const tombolPengaturan = document.getElementById('tombol-pengaturan');
                            if (tombolPengaturan) {
                                // Ubah tampilan tombol agar pas di header
                                tombolPengaturan.classList.remove('w-full', 'py-3', 'bg-gray-200');
                                tombolPengaturan.classList.add('p-2', 'rounded-full', 'hover:bg-gray-200');
                                tombolPengaturan.setAttribute('aria-label', 'Mode Pengaturan');
                                tombolPengaturan.querySelector('span').classList.add('hidden'); // Sembunyikan teks
                                actionSlot.appendChild(tombolPengaturan);
                            }
                        }
                        // 2. Pindahkan tombol Buat Cerita (Cerita Sosial)
                        else if (screenId === 'cerita-module') {
                            actionSlot.innerHTML = ''; // [PERBAIKAN] Kosongkan slot (hapus ikon default)
                            const tombolBuatCerita = document.getElementById('tombol-buat-cerita');
                            if (tombolBuatCerita) {
                                // Ubah tampilan tombol
                                tombolBuatCerita.classList.remove('w-full', 'py-3');
                                tombolBuatCerita.classList.add('p-2', 'rounded-full', 'hover:bg-orange-600');
                                tombolBuatCerita.setAttribute('aria-label', 'Buat Cerita Baru');
                                tombolBuatCerita.querySelector('span').classList.add('hidden'); // Sembunyikan teks
                                actionSlot.appendChild(tombolBuatCerita);
                            }
                        }
                        // 3. Untuk modul lain, ikon default (Profil & Notif) akan tetap terlihat.

                    }
                    
                    // Jalankan inisialisasi modul (jika ada)
                    switch (screenId) {
                        case 'relaksasi-module':
                            // Mulai animasi pernapasan
                            const lingkaran = document.getElementById('relaksasi-lingkaran');
                            lingkaran.style.animation = 'breathe 8s ease-in-out infinite';
                            break;
                        case 'first-then-module':
                            // Muat data tugas saat masuk modul "Pertama... Lalu..."
                            renderFirstThenSetup();
                            break;
                    }
                    
                    activeScreenId = screenId; // Perbarui layar aktif
                } else {
                    mainMenu.classList.remove('hidden'); // Fallback ke main menu
                    activeScreenId = 'main-menu';
                }
            }
            
            // Event listener untuk tombol menu
            menuButtons.forEach(button => {
                const screenId = button.dataset.screen;
                const icon = button.dataset.icon; // Ambil ikon
                if (screenId) {
                    button.addEventListener('click', () => showScreen(screenId, icon));
                }
            });

            // --- [ MODUL 1: JADWAL VISUAL ] ---
            
            const daftarTugasContainer = document.getElementById('daftar-tugas-container');
            const tombolHariBaru = document.getElementById('tombol-hari-baru');
            const tombolPengaturan = document.getElementById('tombol-pengaturan');
            const formTambahTugas = document.getElementById('form-tambah-tugas');
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');

            let modePengaturan = false;

            // Struktur data default
            const dataDefault = {
                tugas: [
                    { id: 1, teks: "Bangun Tidur", emoji: "‚òÄÔ∏è", grup: "pagi", selesai: false },
                    { id: 2, teks: "Mandi Pagi", emoji: "üõÅ", grup: "pagi", selesai: false },
                    { id: 3, teks: "Sarapan", emoji: "ü•û", grup: "pagi", selesai: false },
                    { id: 4, teks: "Makan Siang", emoji: "üç±", grup: "siang", selesai: false },
                    { id: 5, teks: "Sekolah/Terapi", emoji: "üéí", grup: "siang", selesai: false },
                    { id: 6, teks: "Makan Malam", emoji: "üçù", grup: "malam", selesai: false },
                    { id: 7, teks: "Sikat Gigi", emoji: "ü¶∑", grup: "malam", selesai: false },
                    { id: 8, teks: "Tidur", emoji: "üò¥", grup: "malam", selesai: false }
                ]
            };
            
            // Ambil data tugas dari localStorage atau gunakan default
            let dataTugas = JSON.parse(localStorage.getItem('dataJadwalVisual')) || JSON.parse(JSON.stringify(dataDefault));

            // Fungsi untuk menyimpan data ke localStorage
            function simpanDataTugas() {
                localStorage.setItem('dataJadwalVisual', JSON.stringify(dataTugas));
            }

            // Fungsi untuk me-render daftar tugas
            function renderTugas() {
                daftarTugasContainer.innerHTML = '';
                
                const grupTugas = {
                    pagi: dataTugas.tugas.filter(t => t.grup === 'pagi'),
                    siang: dataTugas.tugas.filter(t => t.grup === 'siang'),
                    malam: dataTugas.tugas.filter(t => t.grup === 'malam')
                };

                // Urutan grup
                const urutanGrup = ['pagi', 'siang', 'malam'];
                
                urutanGrup.forEach(namaGrup => {
                    const tugasDiGrup = grupTugas[namaGrup];
                    if (tugasDiGrup.length > 0) {
                        // Buat header grup
                        const headerGrup = document.createElement('h3');
                        headerGrup.className = 'text-xl font-bold text-tenang-teks pt-4';
                        headerGrup.textContent = namaGrup.charAt(0).toUpperCase() + namaGrup.slice(1);
                        daftarTugasContainer.appendChild(headerGrup);

                        // Render tugas di dalam grup
                        tugasDiGrup.forEach(tugas => {
                            const div = document.createElement('div');
                            div.className = `flex items-center justify-between p-4 rounded-lg shadow-sm transition-all duration-300 ${
                                tugas.selesai 
                                    ? 'bg-tenang-hijau bg-opacity-20' 
                                    : 'bg-gray-100'
                            }`;
                            
                            // Konten tugas (emoji + teks)
                            const kontenTugas = document.createElement('div');
                            kontenTugas.className = `flex items-center space-x-3 ${
                                tugas.selesai 
                                    ? 'opacity-60 line-through' 
                                    : ''
                            }`;
                            kontenTugas.innerHTML = `
                                <span class="text-2xl">${tugas.emoji || 'üîπ'}</span>
                                <span class="text-lg font-medium">${tugas.teks}</span>
                            `;

                            // Tombol Aksi (Selesai atau Hapus)
                            const tombolAksi = document.createElement('button');
                            
                            if (modePengaturan) {
                                // Mode Pengaturan: Tombol Hapus
                                tombolAksi.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-tenang-merah" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>`;
                                tombolAksi.setAttribute('aria-label', `Hapus tugas: ${tugas.teks}`);
                                tombolAksi.onclick = () => hapusTugas(tugas.id);
                            } else {
                                // Mode Normal: Tombol Ceklis
                                tombolAksi.innerHTML = tugas.selesai 
                                    ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-tenang-hijau" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>`
                                    : `<div class="w-7 h-7 border-2 border-gray-400 rounded-full"></div>`;
                                tombolAksi.setAttribute('aria-label', `Tandai tugas: ${tugas.teks}`);
                                tombolAksi.onclick = () => toggleTugas(tugas.id, div);
                            }
                            
                            div.appendChild(kontenTugas);
                            div.appendChild(tombolAksi);
                            daftarTugasContainer.appendChild(div);
                        });
                    }
                });
                
                perbaruiProgres();
            }

            // Fungsi untuk update progres bar
            function perbaruiProgres() {
                const totalTugas = dataTugas.tugas.length;
                if (totalTugas === 0) {
                    progressText.textContent = "Belum ada tugas";
                    progressBar.style.width = '0%';
                    return;
                }
                const tugasSelesai = dataTugas.tugas.filter(t => t.selesai).length;
                const persentase = (tugasSelesai / totalTugas) * 100;
                
                progressBar.style.width = `${persentase}%`;
                progressText.textContent = `${tugasSelesai} dari ${totalTugas} tugas selesai`;
            }

            // Fungsi untuk menandai tugas
            function toggleTugas(id, element) {
                const tugas = dataTugas.tugas.find(t => t.id === id);
                if (tugas) {
                    tugas.selesai = !tugas.selesai;
                    
                    if (tugas.selesai) {
                        // Mainkan suara sukses
                        // PERBAIKAN: Menambahkan .catch() untuk menangani error NotSupportedError
                        audioSukses.play().catch(e => console.warn("Tidak dapat memutar audio: ", e));
                    }
                    
                    simpanDataTugas();
                    renderTugas(); // Render ulang
                }
            }

            // Fungsi untuk menghapus tugas
            function hapusTugas(id) {
                tampilkanDialog("Hapus Tugas", "Anda yakin ingin menghapus tugas ini?", () => {
                    dataTugas.tugas = dataTugas.tugas.filter(t => t.id !== id);
                    simpanDataTugas();
                    renderTugas();
                });
            }

            // Fungsi untuk reset jadwal
            function resetJadwal() {
                tampilkanDialog("Mulai Hari Baru", "Ini akan menghapus semua progres. Anda yakin?", () => {
                    dataTugas.tugas.forEach(t => t.selesai = false);
                    simpanDataTugas();
                    renderTugas();
                });
            }
            tombolHariBaru.addEventListener('click', resetJadwal);

            // Toggle mode pengaturan
            tombolPengaturan.addEventListener('click', () => {
                modePengaturan = !modePengaturan;
                formTambahTugas.classList.toggle('hidden');
                
                if (modePengaturan) {
                    tombolPengaturan.classList.add('bg-tenang-biru', 'text-white');
                    tombolPengaturan.classList.remove('bg-gray-200');
                    tombolPengaturan.querySelector('span').textContent = 'Selesai Mengatur';
                } else {
                    tombolPengaturan.classList.remove('bg-tenang-biru', 'text-white');
                    tombolPengaturan.classList.add('bg-gray-200');
                    tombolPengaturan.querySelector('span').textContent = 'Mode Pengaturan';
                }
                renderTugas(); // Render ulang untuk menampilkan tombol hapus/ceklis
            });

            // Event listener untuk form tambah tugas
            formTambahTugas.addEventListener('submit', (e) => {
                e.preventDefault();
                const teks = document.getElementById('input-tugas-teks').value;
                const emoji = document.getElementById('input-tugas-emoji').value;
                const grup = document.getElementById('input-tugas-grup').value;
                
                if (teks.trim() === '') {
                    alert('Nama tugas tidak boleh kosong'); // OK untuk form error
                    return;
                }
                
                const idBaru = dataTugas.tugas.length > 0 ? Math.max(...dataTugas.tugas.map(t => t.id)) + 1 : 1;
                
                dataTugas.tugas.push({
                    id: idBaru,
                    teks: teks,
                    emoji: emoji || 'üîπ',
                    grup: grup,
                    selesai: false
                });
                
                simpanDataTugas();
                renderTugas();
                formTambahTugas.reset();
            });

            // --- [ MODUL 1b: PERTAMA... LALU... ] ---
            
            const ftContainerSetup = document.getElementById('ft-container-setup');
            const ftContainerAktif = document.getElementById('ft-container-aktif');
            const ftContainerSelesai = document.getElementById('ft-container-selesai');
            
            const ftPilihanPertama = document.getElementById('ft-pilihan-pertama');
            const ftPilihanLalu = document.getElementById('ft-pilihan-lalu');
            const ftTombolMulai = document.getElementById('ft-tombol-mulai');
            
            const ftCardPertama = document.getElementById('ft-card-pertama');
            const ftCardLalu = document.getElementById('ft-card-lalu');
            const ftTombolSelesai = document.getElementById('ft-tombol-selesai');
            
            const ftCardHadiahFinal = document.getElementById('ft-card-hadiah-final');
            const ftTombolKembali = document.getElementById('ft-tombol-kembali');

            // Data hadiah (bisa dikustomisasi juga nanti)
            const daftarHadiah = [
                { id: 'h1', teks: 'Main iPad', emoji: 'üì±' },
                { id: 'h2', teks: 'Nonton TV', emoji: 'üì∫' },
                { id: 'h3', teks: 'Makan Es Krim', emoji: 'üç¶' },
                { id: 'h4', teks: 'Main Mobilan', emoji: 'üöó' },
                { id: 'h5', teks: 'Dengar Lagu', emoji: 'üé∂' },
                { id: 'h6', teks: 'Cemilan', emoji: 'üç™' },
            ];
            
            let pilihanPertama = null;
            let pilihanLalu = null;

            // Fungsi untuk membuat kartu pilihan
            function buatKartuPilihan(item, tipe) {
                const button = document.createElement('button');
                button.className = `p-3 rounded-lg shadow-sm flex flex-col items-center justify-center space-y-1 transition-all ${
                    tipe === 'pertama' ? 'bg-gray-100' : 'bg-tenang-hijau bg-opacity-20'
                }`;
                button.dataset.id = item.id;
                button.innerHTML = `
                    <span class="text-3xl">${item.emoji}</span>
                    <span class="text-xs font-medium text-center">${item.teks}</span>
                `;
                
                button.addEventListener('click', () => {
                    if (tipe === 'pertama') {
                        pilihanPertama = item;
                        // Hapus border dari pilihan sebelumnya
                        Array.from(ftPilihanPertama.children).forEach(child => child.classList.remove('ring-4', 'ring-tenang-biru'));
                        // Tambah border ke pilihan baru
                        button.classList.add('ring-4', 'ring-tenang-biru');
                    } else {
                        pilihanLalu = item;
                        Array.from(ftPilihanLalu.children).forEach(child => child.classList.remove('ring-4', 'ring-tenang-hijau'));
                        button.classList.add('ring-4', 'ring-tenang-hijau');
                    }
                    // Cek apakah tombol Mulai bisa diaktifkan
                    ftTombolMulai.disabled = !(pilihanPertama && pilihanLalu);
                });
                return button;
            }
            
            // Fungsi untuk render layar setup
            function renderFirstThenSetup() {
                // Reset state
                pilihanPertama = null;
                pilihanLalu = null;
                ftTombolMulai.disabled = true;

                // Tampilkan layar setup, sembunyikan yang lain
                ftContainerSetup.classList.remove('hidden');
                ftContainerAktif.classList.add('hidden');
                ftContainerSelesai.classList.add('hidden');

                // Render Pilihan "Pertama" (ambil dari tugas yang BELUM selesai)
                ftPilihanPertama.innerHTML = '';
                const tugasBelumSelesai = dataTugas.tugas.filter(t => !t.selesai);
                if (tugasBelumSelesai.length > 0) {
                    tugasBelumSelesai.forEach(tugas => {
                        ftPilihanPertama.appendChild(buatKartuPilihan(tugas, 'pertama'));
                    });
                } else {
                    ftPilihanPertama.innerHTML = '<p class="col-span-3 text-center text-gray-500">Semua tugas sudah selesai! üéâ</p>';
                }
                
                // Render Pilihan "Lalu"
                ftPilihanLalu.innerHTML = '';
                daftarHadiah.forEach(hadiah => {
                    ftPilihanLalu.appendChild(buatKartuPilihan(hadiah, 'lalu'));
                });
            }
            
            // Event listener untuk tombol "Mulai"
            ftTombolMulai.addEventListener('click', () => {
                if (!pilihanPertama || !pilihanLalu) return;
                
                // Isi konten layar "Aktif"
                ftCardPertama.innerHTML = `
                    <span class="text-5xl">${pilihanPertama.emoji}</span>
                    <span class="text-2xl font-semibold">${pilihanPertama.teks}</span>
                `;
                ftCardLalu.innerHTML = `
                    <span class="text-5xl">${pilihanLalu.emoji}</span>
                    <span class="text-2xl font-semibold">${pilihanLalu.teks}</span>
                `;
                
                // Pindah layar
                ftContainerSetup.classList.add('hidden');
                ftContainerAktif.classList.remove('hidden');
                ftContainerSelesai.classList.add('hidden');
            });
            
            // Event listener untuk tombol "Aku Sudah Selesai!"
            ftTombolSelesai.addEventListener('click', () => {
                // Tandai tugas sebagai selesai di data utama
                toggleTugas(pilihanPertama.id);
                
                // Mainkan suara "Hore"
                // PERBAIKAN: Menambahkan .catch()
                audioHore.play().catch(e => console.warn("Tidak dapat memutar audio: ", e));
                
                // Isi konten layar "Selesai"
                ftCardHadiahFinal.innerHTML = `
                    <span class="text-5xl">${pilihanLalu.emoji}</span>
                    <span class="text-2xl font-semibold">${pilihanLalu.teks}</span>
                `;
                
                // Pindah layar
                ftContainerSetup.classList.add('hidden');
                ftContainerAktif.classList.add('hidden');
                ftContainerSelesai.classList.remove('hidden');
            });

            // Event listener untuk tombol "Selesai" (di layar Hore)
            ftTombolKembali.addEventListener('click', () => {
                // Kembali ke layar setup "Pertama... Lalu..."
                renderFirstThenSetup();
            });


            // --- [ MODUL 2: KENALI EMOSI ] ---
            
            const emosiPertanyaan = document.getElementById('emosi-pertanyaan');
            const emosiPilihanContainer = document.getElementById('emosi-pilihan');
            const emosiUmpanBalik = document.getElementById('emosi-umpan-balik');

            const bankEmosi = [
                { emoji: "üòä", jawaban: "Senang", pilihan: ["Sedih", "Marah"] },
                { emoji: "üò¢", jawaban: "Sedih", pilihan: ["Senang", "Takut"] },
                { emoji: "üò†", jawaban: "Marah", pilihan: ["Bosan", "Senang"] },
                { emoji: "üò®", jawaban: "Takut", pilihan: ["Kaget", "Marah"] },
                { emoji: "üò¥", jawaban: "Mengantuk", pilihan: ["Senang", "Sedih"] },
                { emoji: "üòÆ", jawaban: "Kaget", pilihan: ["Takut", "Mengantuk"] },
            ];
            
            let emosiSaatIni = 0;

            function muatEmosi(index) {
                // Reset umpan balik
                emosiUmpanBalik.classList.add('hidden');
                emosiUmpanBalik.textContent = '';

                const emosi = bankEmosi[index];
                emosiPertanyaan.textContent = emosi.emoji;
                
                // Acak pilihan jawaban
                const pilihan = [emosi.jawaban, ...emosi.pilihan].sort(() => Math.random() - 0.5);
                
                emosiPilihanContainer.innerHTML = ''; // Kosongkan pilihan lama
                
                pilihan.forEach(p => {
                    const button = document.createElement('button');
                    button.textContent = p;
                    button.className = "w-full px-4 py-4 bg-tenang-biru text-white text-lg rounded-lg font-semibold hover:bg-blue-700 transition-colors";
                    
                    button.addEventListener('click', () => {
                        // Nonaktifkan semua tombol sementara
                        emosiPilihanContainer.querySelectorAll('button').forEach(btn => btn.disabled = true);
                        
                        if (p === emosi.jawaban) {
                            // Jawaban Benar
                            emosiUmpanBalik.textContent = "Benar! üëç";
                            emosiUmpanBalik.className = 'feedback-message feedback-correct';
                            
                            // Lanjut ke emosi berikutnya setelah 1.5 detik
                            setTimeout(() => {
                                emosiSaatIni = (emosiSaatIni + 1) % bankEmosi.length;
                                muatEmosi(emosiSaatIni);
                            }, 1500);
                            
                        } else {
                            // Jawaban Salah
                            emosiUmpanBalik.textContent = "Coba lagi...";
                            emosiUmpanBalik.className = 'feedback-message feedback-wrong';
                            
                            // Aktifkan kembali tombol setelah 1 detik
                            setTimeout(() => {
                                emosiUmpanBalik.classList.add('hidden');
                                emosiPilihanContainer.querySelectorAll('button').forEach(btn => btn.disabled = false);
                            }, 1000);
                        }
                        
                        emosiUmpanBalik.classList.remove('hidden');
                    });
                    
                    emosiPilihanContainer.appendChild(button);
                });
            }

            // --- [ MODUL 3: AKU MAU... (KOMUNIKASI) ] ---
            
            const komunikasiContainer = document.getElementById('komunikasi-container');
            const bankKomunikasi = [
                { teks: "Aku mau makan", emoji: "üçî", warna: "bg-tenang-hijau" },
                { teks: "Aku mau minum", emoji: "ü•§", warna: "bg-tenang-biru" },
                { teks: "Aku mau ke toilet", emoji: "üöΩ", warna: "bg-tenang-kuning" },
                { teks: "Aku mau istirahat", emoji: "üõå", warna: "bg-tenang-ungu" },
                { teks: "Aku mau bermain", emoji: "üß©", warna: "bg-tenang-oranye" },
                { teks: "Aku merasa sakit", emoji: "ü§í", warna: "bg-tenang-merah" },
                { teks: "Ya", emoji: "üëç", warna: "bg-gray-400" },
                { teks: "Tidak", emoji: "üëé", warna: "bg-gray-400" },
            ];

            // Cek ketersediaan Web Speech API
            const speechReady = 'speechSynthesis' in window;
            
            function ucapkan(teks) {
                if (!speechReady) {
                    console.warn("Speech Synthesis tidak didukung di browser ini.");
                    return;
                }
                // Hentikan ucapan sebelumnya (jika ada)
                window.speechSynthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance(teks);
                utterance.lang = 'id-ID'; // Set bahasa ke Indonesia
                utterance.rate = 0.9; // Sedikit lebih lambat agar jelas
                window.speechSynthesis.speak(utterance);
            }

            function muatKomunikasi() {
                komunikasiContainer.innerHTML = '';
                bankKomunikasi.forEach(item => {
                    const button = document.createElement('button');
                    /* [PERBAIKAN TAMPILAN] Mengubah shadow-sm menjadi shadow-lg, menambah durasi, dan hover:shadow-xl */
                    button.className = `p-4 rounded-lg shadow-lg flex flex-col items-center justify-center space-y-2 text-white transition-all duration-200 transform hover:scale-105 hover:shadow-xl ${item.warna}`;
                    button.innerHTML = `
                        <span class="text-5xl">${item.emoji}</span>
                        <span class="font-semibold text-center">${item.teks}</span>
                    `;
                    
                    button.addEventListener('click', () => {
                        ucapkan(item.teks);
                        // Efek visual saat diklik
                        button.style.transform = 'scale(0.95)';
                        setTimeout(() => button.style.transform = 'scale(1.05)', 100);
                        setTimeout(() => button.style.transform = 'scale(1.0)', 200);
                    });
                    
                    komunikasiContainer.appendChild(button);
                });
                
                if (!speechReady) {
                    // [PERBAIKAN FITUR] Tampilkan pesan error di UI
                    komunikasiContainer.insertAdjacentHTML('afterbegin', '<p class="col-span-2 text-center text-red-600 p-4 bg-red-100 rounded-lg font-semibold">Fitur suara tidak didukung di browser ini.</p>');
                }
            }

            // --- [ MODUL 4: AYO TENANG (RELAKSASI) ] ---
            
            const relaksasiLingkaran = document.getElementById('relaksasi-lingkaran');
            const relaksasiStatusOuter = document.getElementById('relaksasi-status-outer');
            const relaksasiStatusInner = document.getElementById('relaksasi-status-inner');

            // Set interval untuk mengubah teks (setengah dari durasi animasi 8s)
            setInterval(() => {
                if (activeScreenId !== 'relaksasi-module') return;
                
                setTimeout(() => {
                    if (activeScreenId !== 'relaksasi-module') return;
                    relaksasiStatusOuter.textContent = "Hembuskan Napas...";
                    relaksasiStatusInner.textContent = "Hembuskan...";
                    relaksasiStatusInner.style.opacity = '1';
                }, 0); // Mulai transisi teks luar segera
                
                setTimeout(() => {
                    if (activeScreenId !== 'relaksasi-module') return;
                    relaksasiStatusOuter.textContent = "Tarik Napas...";
                    relaksasiStatusInner.textContent = "Tarik Napas...";
                    relaksasiStatusInner.style.opacity = '1';
                }, 4000); // Setengah siklus
            
            }, 8000); // Siklus penuh

            // --- [ MODUL 5: CERITA SOSIAL (AI) ] ---
            
            const tombolBuatCerita = document.getElementById('tombol-buat-cerita');
            const ceritaLoading = document.getElementById('cerita-loading');
            const ceritaContainer = document.getElementById('cerita-container');
            const ceritaSkenario = document.getElementById('cerita-skenario');
            const ceritaPilihan = document.getElementById('cerita-pilihan');
            const ceritaUmpanBalik = document.getElementById('cerita-umpan-balik');

            // !! PERINGATAN KEAMANAN !!
            // Kunci API ini terekspos di frontend. Ini SANGAT TIDAK AMAN untuk produksi.
            // Gunakan backend untuk melindungi kunci Anda.
            // Untuk PENGUJIAN, ganti "" dengan Kunci API Gemini Anda.
            const apiKey = ""; // <-- MASUKKAN KUNCI API GEMINI ANDA DI SINI
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            // Instruksi sistem untuk AI
            const systemInstruction = {
                parts: [{
                    text: "Anda adalah asisten terapi perilaku untuk anak autisme. Buatlah skenario cerita sosial yang sangat sederhana dan umum terjadi dalam 1 kalimat (misal: 'Temanmu mengambil mainanmu'). Berikan dua pilihan: 'pil_a' (respons yang kurang tepat, misal: 'Marah dan berteriak') dan 'pil_b' (respons yang lebih baik, misal: 'Meminta mainan kembali dengan baik'). Berikan juga 'umpan_balik' singkat 1 kalimat untuk pilihan B (misal: 'Bagus, meminta dengan baik adalah cara yang hebat!'). Jawab HANYA dalam format JSON yang diminta."
                }]
            };

            // Skema JSON untuk output AI
            const responseSchema = {
                type: "OBJECT",
                properties: {
                    "skenario": { "type": "STRING" },
                    "pil_a": { "type": "STRING" },
                    "pil_b": { "type": "STRING" },
                    "umpan_balik": { "type": "STRING" }
                },
                required: ["skenario", "pil_a", "pil_b", "umpan_balik"]
            };
            
            function initCeritaSosial() {
                tombolBuatCerita.addEventListener('click', () => {
                    if (apiKey === "") {
                        tampilkanPesanError("Fitur ini memerlukan Kunci API Gemini untuk berfungsi.");
                        return;
                    }
                    panggilGeminiAPI();
                });
            }

            // Fungsi untuk memanggil Gemini API dengan retry logic
            async function panggilGeminiAPI(retryCount = 0) {
                ceritaLoading.classList.remove('hidden');
                tombolBuatCerita.disabled = true;
                ceritaContainer.classList.add('hidden');
                ceritaUmpanBalik.classList.add('hidden');

                const payload = {
                    contents: [{
                        parts: [{ text: "Buat satu cerita sosial baru." }]
                    }],
                    systemInstruction: systemInstruction,
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: responseSchema,
                        temperature: 1.0, // Kreatif
                        topP: 0.9,
                    }
                };

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        // Handle rate limit (429) dengan exponential backoff
                        if (response.status === 429 && retryCount < 3) {
                            const delay = Math.pow(2, retryCount) * 1000 + Math.random() * 1000;
                            console.warn(`Rate limit. Mencoba lagi dalam ${delay}ms...`);
                            await new Promise(resolve => setTimeout(resolve, delay));
                            panggilGeminiAPI(retryCount + 1); // Coba lagi
                            return;
                        }
                        throw new Error(`API Error: ${response.statusText}`);
                    }

                    const result = await response.json();
                    
                    if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0].text) {
                        const jsonText = result.candidates[0].content.parts[0].text;
                        const data = JSON.parse(jsonText);
                        tampilkanCerita(data);
                    } else {
                        throw new Error("Format respons API tidak valid.");
                    }

                } catch (error) {
                    console.error("Gagal mengambil cerita:", error);
                    tampilkanPesanError("Maaf, gagal membuat cerita. Coba lagi nanti.");
                } finally {
                    ceritaLoading.classList.add('hidden');
                    tombolBuatCerita.disabled = false;
                }
            }
            
            // Fungsi untuk menampilkan cerita di UI
            function tampilkanCerita(data) {
                const { skenario, pil_a, pil_b, umpan_balik } = data;
                
                ceritaSkenario.textContent = skenario;
                ceritaPilihan.innerHTML = '';
                ceritaUmpanBalik.classList.add('hidden');
                
                // Tombol Pilihan A (Kurang Tepat)
                const buttonA = document.createElement('button');
                buttonA.textContent = pil_a;
                buttonA.className = "w-full px-4 py-3 bg-gray-200 text-gray-700 text-lg rounded-lg font-medium hover:bg-gray-300 transition-colors";
                buttonA.setAttribute('role', 'button');
                buttonA.setAttribute('aria-label', `Pilihan: ${pil_a}`);
                buttonA.addEventListener('click', () => {
                    ceritaUmpanBalik.textContent = "Oh, coba pikirkan cara lain yang lebih baik...";
                    ceritaUmpanBalik.className = 'feedback-message feedback-wrong';
                    ceritaUmpanBalik.classList.remove('hidden');
                });
                
                // Tombol Pilihan B (Lebih Baik)
                const buttonB = document.createElement('button');
                buttonB.textContent = pil_b;
                buttonB.className = "w-full px-4 py-3 bg-tenang-biru text-white text-lg rounded-lg font-semibold hover:bg-blue-700 transition-colors";
                buttonB.setAttribute('role', 'button');
                buttonB.setAttribute('aria-label', `Pilihan: ${pil_b}`);
                buttonB.addEventListener('click', () => {
                    ceritaUmpanBalik.textContent = `${umpan_balik} üëç`;
                    ceritaUmpanBalik.className = 'feedback-message feedback-correct';
                    ceritaUmpanBalik.classList.remove('hidden');
                });
                
                // Tambahkan event keydown untuk aksesibilitas
                [buttonA, buttonB].forEach(btn => {
                    btn.addEventListener('keydown', (e) => {
                         if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            btn.click();
                         }
                    });
                });

                ceritaPilihan.appendChild(buttonA);
                ceritaPilihan.appendChild(buttonB);
                ceritaContainer.classList.remove('hidden');
            }
            
            // Fungsi untuk menampilkan pesan error di UI
            function tampilkanPesanError(message) {
                ceritaSkenario.textContent = '';
                ceritaPilihan.innerHTML = '';
                ceritaUmpanBalik.textContent = message;
                ceritaUmpanBalik.className = 'feedback-message feedback-wrong';
                ceritaUmpanBalik.classList.remove('hidden');
                ceritaContainer.classList.remove('hidden');
            }

            // --- [ MODUL 6: MUSIK RILEKS (BARU) ] ---
            
            let musicPlayer = null;
            let musicPlaying = false;
            const tombolPlayPauseMusik = document.getElementById('tombol-play-pause-musik');
            const musicAnimation = document.getElementById('music-animation');
            // [TAMBAHAN BARU] Ambil elemen MP3 player
            const inputMp3 = document.getElementById('input-mp3');
            const playerMp3 = document.getElementById('player-mp3');
            
            function initMusicPlayer() {
                // Cek jika Tone.js sudah dimuat
                if (typeof Tone === 'undefined') {
                    console.warn("Tone.js tidak terdeteksi. Fitur musik dinonaktifkan.");
                    // Sembunyikan tombol menu jika Tone.js gagal dimuat
                    const musicMenuButton = document.querySelector('button[data-screen="musik-module"]');
                    if(musicMenuButton) musicMenuButton.classList.add('hidden');
                    
                    // [PERBAIKAN FITUR] Tampilkan pesan error di UI jika pengguna masuk ke modul
                    const musikContainer = document.getElementById('tombol-play-pause-musik')?.parentElement;
                    if (musikContainer) {
                        musikContainer.innerHTML = '<p class="text-center text-red-600 p-4 bg-red-100 rounded-lg font-semibold">Gagal memuat pustaka musik (Tone.js). Fitur ini dinonaktifkan.</p>';
                    }
                    return;
                }

                // Membuat synth polifonik dengan efek
                musicPlayer = new Tone.PolySynth(Tone.Synth, {
                    oscillator: { type: "fatsawtooth", count: 3, spread: 30 },
                    envelope: {
                        attack: 0.01, decay: 0.1, sustain: 0.5, release: 0.4, attackCurve: "exponential"
                    }
                }).toDestination();
                
                const reverb = new Tone.Reverb(2.5).toDestination(); // Reverb 2.5 detik
                const delay = new Tone.FeedbackDelay("8n", 0.3).toDestination(); // Delay
                musicPlayer.connect(reverb);
                musicPlayer.connect(delay);

                // Melodi sederhana yang menenangkan (Chord Progression: C - G - Am - F)
                const melodi = [
                    {'time': '0:0', 'note': ['C4', 'E4', 'G4'], 'duration': '1m'},
                    {'time': '1:0', 'note': ['G3', 'B3', 'D4'], 'duration': '1m'},
                    {'time': '2:0', 'note': ['A3', 'C4', 'E4'], 'duration': '1m'},
                    {'time': '3:0', 'note': ['F3', 'A3', 'C4'], 'duration': '1m'}
                ];

                const part = new Tone.Part((time, value) => {
                    musicPlayer.triggerAttackRelease(value.note, value.duration, time);
                }, melodi).start(0);
                
                part.loop = true; // Ulangi melodi
                part.loopEnd = '4m'; // Loop setiap 4 measures
                Tone.Transport.bpm.value = 65; // BPM lambat dan menenangkan

                // Kontrol tombol play/pause (Tone.js)
                tombolPlayPauseMusik.addEventListener('click', async () => {
                    // Memulai audio context (penting untuk browser)
                    try {
                        await Tone.start();
                    } catch (e) {
                        console.error("Gagal memulai Audio Context:", e);
                        return; // Hentikan jika audio context gagal
                    }
                    
                    if (musicPlaying) {
                        // Jeda Musik
                        Tone.Transport.pause();
                        tombolPlayPauseMusik.textContent = 'Mulai Musik';
                        tombolPlayPauseMusik.classList.replace('bg-tenang-merah', 'bg-tenang-biru');
                        musicAnimation.classList.remove('animate-music-pulse');
                    } else {
                        // Mainkan Musik
                        playerMp3.pause(); // [LOGIKA KONFLIK] Jeda MP3 player jika sedang main
                        Tone.Transport.start();
                        tombolPlayPauseMusik.textContent = 'Jeda Musik';
                        tombolPlayPauseMusik.classList.replace('bg-tenang-biru', 'bg-tenang-merah');
                        musicAnimation.classList.add('animate-music-pulse');
                    }
                    musicPlaying = !musicPlaying;
                });

                // [TAMBAHAN BARU] Kontrol untuk MP3 player
                inputMp3.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        try {
                            const fileURL = URL.createObjectURL(file);
                            playerMp3.src = fileURL;
                            playerMp3.classList.remove('hidden');
                            playerMp3.play(); 
                            // Event listener 'play' di bawah akan otomatis menangani konflik
                        } catch (err) {
                            console.error("Gagal memuat file MP3:", err);
                            // Gunakan dialog kustom jika ada, atau alert sederhana
                            tampilkanDialog("Error", "Maaf, gagal memuat file audio tersebut.", () => {});
                        }
                    }
                });

                // [TAMBAHAN BARU] Logika konflik saat MP3 player dimainkan
                playerMp3.addEventListener('play', () => {
                    if (musicPlaying) {
                        // Jika Tone.js sedang main, klik tombolnya untuk jeda
                        tombolPlayPauseMusik.click();
                    }
                });
            }

            // --- Inisialisasi Aplikasi ---
            showScreen('main-menu'); // Tampilkan menu utama saat pertama kali dimuat
            renderTugas(); // Muat tugas dari localStorage
            muatEmosi(emosiSaatIni); // Muat emosi pertama
            muatKomunikasi(); // Muat kartu komunikasi
            initCeritaSosial(); // Inisialisasi tombol cerita
            initMusicPlayer(); // Inisialisasi pemutar musik [BARU]

        });
    </script>
</body>
</html>